........................................................................ [ 87%]
.....E
=================================== ERRORS ====================================
__________________ ERROR at setup of test_profile_generation __________________
file C:\Users\admin\Downloads\animerpg\aidm_v3\tests\test_profile_flow.py, line 46
  async def test_profile_generation(anime_name: str) -> dict:
      """
      Test the complete profile generation flow.

      Returns dict with test results.
      """
      from src.agents.profile_generator import generate_and_save_profile, _sanitize_profile_id
      from src.context.profile_library import get_profile_library

      results = {
          "anime": anime_name,
          "profile_id": None,
          "yaml_created": False,
          "lore_created": False,
          "lore_length": 0,
          "chroma_chunks": 0,
          "errors": []
      }

      profiles_dir = Path(__file__).parent.parent / "src" / "profiles"
      profile_id = _sanitize_profile_id(anime_name)
      results["profile_id"] = profile_id

      yaml_path = profiles_dir / f"{profile_id}.yaml"
      lore_path = profiles_dir / f"{profile_id}_lore.txt"

      # Clean up any existing files first
      if yaml_path.exists():
          yaml_path.unlink()
          print(f"  [Cleanup] Removed existing {yaml_path.name}")
      if lore_path.exists():
          lore_path.unlink()
          print(f"  [Cleanup] Removed existing {lore_path.name}")

      # Run profile generation
      print_header(f"Generating Profile: {anime_name}")
      print(f"  Profile ID: {profile_id}")
      print(f"  Started: {datetime.now().strftime('%H:%M:%S')}")
      print()

      try:
          profile = await generate_and_save_profile(anime_name)
          print(f"\n  Completed: {datetime.now().strftime('%H:%M:%S')}")
          print(f"  Confidence: {profile.get('confidence', 'N/A')}%")
      except Exception as e:
          results["errors"].append(f"Generation failed: {e}")
          print(f"\n  ERROR: {e}")
          return results

      # Test 1: YAML file exists
      print_header("Verification Results")

      yaml_exists = yaml_path.exists()
      results["yaml_created"] = yaml_exists
      if yaml_exists:
          yaml_size = yaml_path.stat().st_size
          print_result("YAML Profile", True, f"{yaml_path.name} ({yaml_size} bytes)")
      else:
          print_result("YAML Profile", False, f"Expected: {yaml_path}")

      # Test 2: Lore file exists and has content
      lore_exists = lore_path.exists()
      if lore_exists:
          lore_content = lore_path.read_text(encoding='utf-8')
          lore_len = len(lore_content)
          results["lore_created"] = True
          results["lore_length"] = lore_len

          # Check minimum length
          if lore_len >= 200:
              print_result("Lore Text File", True, f"{lore_path.name} ({lore_len} chars)")
          else:
              print_result("Lore Text File", False, f"Too short: {lore_len} chars (min 200)")
      else:
          print_result("Lore Text File", False, f"Expected: {lore_path}")

      # Test 3: ChromaDB chunks
      try:
          library = get_profile_library()
          # Query for chunks with this profile_id
          chunk_results = library.collection.get(
              where={"profile_id": profile_id},
              limit=100
          )
          chunk_count = len(chunk_results.get('ids', []))
          results["chroma_chunks"] = chunk_count

          if chunk_count > 0:
              print_result("ChromaDB Chunks", True, f"{chunk_count} chunks indexed")
          else:
              print_result("ChromaDB Chunks", False, "No chunks found in collection")
      except Exception as e:
          print_result("ChromaDB Chunks", False, f"Error: {e}")
          results["errors"].append(f"ChromaDB check failed: {e}")

      # Summary
      print_header("Summary")
      all_passed = (
          results["yaml_created"] and
          results["lore_created"] and
          results["lore_length"] >= 200 and
          results["chroma_chunks"] > 0
      )

      if all_passed:
          print("  \\033[92m\u2713 ALL TESTS PASSED\\033[0m")
      else:
          print("  \\033[91m\u2717 SOME TESTS FAILED\\033[0m")
          if results["errors"]:
              print("\n  Errors:")
              for err in results["errors"]:
                  print(f"    - {err}")

      return results
E       fixture 'anime_name' not found
>       available fixtures: _class_scoped_runner, _function_scoped_runner, _module_scoped_runner, _package_scoped_runner, _session_scoped_runner, anyio_backend, anyio_backend_name, anyio_backend_options, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, capteesys, doctest_namespace, event_loop_policy, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, subtests, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory
>       use 'pytest --fixtures [testpath]' for help on them.

C:\Users\admin\Downloads\animerpg\aidm_v3\tests\test_profile_flow.py:46
============================== warnings summary ===============================
src\settings\models.py:166
  C:\Users\admin\Downloads\animerpg\aidm_v3\src\settings\models.py:166: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class UserSettings(BaseModel):

tests/test_core_loop.py: 11 warnings
tests/test_deferred_commit.py: 26 warnings
tests/test_foreshadowing_persistence.py: 29 warnings
  C:\Users\admin\Downloads\animerpg\aidm_v3\venv313\Lib\site-packages\sqlalchemy\sql\schema.py:3624: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    return util.wrap_callable(lambda ctx: fn(), fn)  # type: ignore

tests/test_deferred_commit.py::TestStateTransactionWithDeferredCommit::test_transaction_within_deferred_commit
  C:\Users\admin\Downloads\animerpg\aidm_v3\src\core\state_transaction.py:28: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class StateChange(BaseModel):

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
ERROR tests/test_profile_flow.py::test_profile_generation
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 1 failures !!!!!!!!!!!!!!!!!!!!!!!!!!
77 passed, 68 warnings, 1 error in 110.32s (0:01:50)
